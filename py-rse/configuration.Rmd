# Program Configuration {#py-rse-configuration}

In previous chapters we've used command-line options to configure our word count scripts. 
Depending on how complex we'd like to make our programs,
there are actually a number of layers of configuration that we could use:

1.  A system-wide configuration file for general settings.
2.  A user-specific configuration file for personal preferences.
3.  A job-specific file with settings for a specific run.
4.  Command-line options to change things that commonly change.

This is sometimes called [overlay configuration][overlay-configuration]
because each level overrides the ones above it:
the user's configuration file overrides the system settings,
the job configuration overrides the user's defaults,
and the command-line options overrides that.
While this is far more complexity than most research software needs (at least initially),
being able to read a complete set of options from a file is a big boost to reproducibility.

## Configuration file formats

Programmers have invented many formats for configuration files,
so please do not create your own.
One possibility is to write the configuration as a Python data structure
and then load it as if it was a library.
This is clever,
but it's hard for tools in other languages to process.
A second option is the [Windows INI format][ini-format],
which is laid out like this:

```text
[section_1]
key_1=value_1
key_2=value_2

[section_2]
key_3=value_3
key_4=value_4
```

INI files are simple to read and write,
but the format is slowly falling out of use in favor of [YAML][yaml]
(AppendixÂ \@ref(py-rse-yaml)).
Here's a sample YAML configuration file:

```yaml
# Standard settings for thesis.
logfile: "/tmp/log.txt"
quiet: false
overwrite: false
fonts:
- Verdana
- Serif
```

## Configuring plot labels

To see overlay configuration in action,
let's consider one of the most common tasks in data science -
changing the size of the labels on a plot.
The size of the labels on our Jane Eyre word count plot
is fine for viewing on our screen,
but they'll need to be bigger
if we want to include the figure in a powerpoint presentation or report.

TODO: Include Jane Eyre figure

In order to configure the label sizes,
we could use a number of the options described above:
-  Edit a user-specific YAML file known as the `matplotlibrc` file
-  Create a job-specific YAML file that the `plotcounts.py` script can parse
-  Add some new command-line options to `plotcounts.py` 

Let's consider these options one at a time.

### Edit the matplotlibrc file

Our first option would be to edit the user-specific matplotlib runtime configuration file
(a.k.a. the `matpllotlibrc` file).
When we import matplotlib,
it locates this YAML file in order to set the default characteristics
(i.e. colors, sizes and formats) of the various aspects of the plot. 
We can find its location on our system by running the following command:

```python
import matplotlib as mpl

mpl.matplotlib_fname()
```

```text
/Users/amira/opt/anaconda3/lib/python3.7/site-packages/matplotlib/mpl-data/matplotlibrc
```

We can see from opening this file that the default size of the x and y axis labels
and also the tick labels is medium:

```python
#axes.labelsize      : medium  ## fontsize of the x any y labels
#xtick.labelsize      : medium ## fontsize of the tick labels
#ytick.labelsize      : medium ## fontsize of the tick labels
```

We can uncomment those lines, change the sizes,

```python
axes.labelsize      : x-large  ## fontsize of the x any y labels
xtick.labelsize      : large ## fontsize of the tick labels
ytick.labelsize      : large ## fontsize of the tick labels
```
and then re-generate the Jane Eyre plot with bigger labels:

```python
$ python plotcounts.py jane_eyre.csv --outfile jane_eyre.png
```

TODO: Include Jane Eyre plot with bigger labels

This approach has done the job,
but labels will now be this large for any plot that we generate in the future,
regardless of whether that plot relates to word counts or not.
If we don't want to lock ourselves into these bigger default values,
we should try a different approach.

### New command line options

A second option would be to add some more command line arguments to `plotcounts.py`.
This would involve defining new optional inputs using argparse,

```python
mpl_sizes = ['xx-small', 'x-small', 'small', 'medium', 'large', 'x-large', 'xx-large']
parser.add_argument('--labelsize', type=str, default='x-large', choices=mpl_sizes,
                    help='fontsize of the x any y labels')
parser.add_argument('--xticksize', type=str, default='large', choices=mpl_sizes,
                    help='fontsize of the x tick labels')
parser.add_argument('--yticksize', type=str, default='large', choices=mpl_sizes,
                    help='fontsize of the y tick labels')
```

and then adding a few lines after the `ax` variable is defined:

```python
ax.xaxis.label.set_fontsize(args.labelsize)
ax.yaxis.label.set_fontsize(args.labelsize)
ax.xaxis.set_tick_params(labelsize=args.xticksize)
ax.yaxis.set_tick_params(labelsize=args.yticksize)
```

Alternatively, 

mpl.rcParams[param]

(This must be done before the plot is generated)


### Job-specific YAML file

Can either pass the YAML file to the script 

```python
def set_plot_params(param_file):
    """Set the matplotlib rc parameters."""
    if param_file:
        with open(param_file, 'r') as reader:
            param_dict = yaml.load(reader, Loader=yaml.BaseLoader)
    else:
        param_dict = {}
    for param, value in param_dict.items():
        mpl.rcParams[param] = value
```

Or create a custom style following
https://matplotlib.org/3.1.1/tutorials/introductory/customizing.html
and then just call it:

```python
plt.style.use('presentation')
```

Since we are going to be packing this (and thus can't put it in the users matplotlib directory)
the former approach is better.


## Exercises {#py-rse-configuration-exercises}

TODO

## Key Points {#py-rse-configuration-keypoints}

```{r, child="keypoints/py-rse-configuration.md"}
```

```{r, child="./links.md"}
```
