# Continuous Integration {#py-rse-ci}

```{r py-rse-ci-setup, include=FALSE}
source(here::here("_common.R"))
```

[Continuous integration][continuous-integration] (CI) is a relatively simple idea:
run checks and tests automatically whenever changes have been made to a project.
This tells developers immediately if their changes have caused problems,
that way its easier to fix the problem by seeing what was changed.
Automation tools like Make (Chapter \@ref(py-rse-automate)) can compile software,
run tests, re-do analyses,
and re-create reports with a single command;
CI tools can run those commands and give users feedback every time
something changes in the project's repository.
These tools can also be set up to run tests with several different configurations of the software
or on several different operating systems,
so that if (for example) a programmer makes a change on Windows 
and it then breaks only for Mac users or vice versa,
they can find out before releasing the software to others.

This chapter introduces a CI tool called [Travis CI][travis-ci]
that integrates well with [GitHub][github].
If Travis CI has been set up,
then every time a change is committed to a GitHub repository,
Travis CI creates a fresh environment,
make a fresh clone of the repository
(which is described in Chapter \@ref(py-rse-git-advanced-fork)),
and runs whatever commands the project's managers have set up.
If the project uses a language like C++ or Java,
those commands usually start by compiling the source code to create a runnable program.
By combining what we covered in Chapter \@ref(py-rse-correct) on unit testing
and in Section \@ref(py-rse-git-advanced-merge) on using branches,
we can use Travis CI to run tests on the branches to check if everything runs correctly
before merging into the master branch.
We can also use other commands with Travis CI.
For example,
Travis CI re-creates the PDF and HTML versions of this book
every time a pull request is merged from contributors.

> **Virtual Machines**
>
> A [virtual machine][virtual-machine] (VM) is a program that pretends to be a computer.
> This may seem a bit redundant,
> but VMs are quick to create and start up,
> and changes made inside the virtual machine are contained within that VM
> so we can install new packages or run a completely different operating system
> without affecting the underlying computer.
> 
> Every time Travis CI runs,
> it creates a new virtual machine to ensure that builds and tests run in a completely clean environment:
> nothing left over from previous attempts to compile, run, or publish will affect the current attempt.

## Setting up continuous integration {#py-rse-ci-basic}

### Creating a Travis account to watch a repository

To set up CI for your project, you first must:

1.  Create an account on [Travis CI][travis-ci].
1.  Link your Travis CI account to your GitHub account.
1.  Tell Travis CI to watch the repository that contains your project.

Creating an account with an online service may likely be a familiar process,
but linking your Travis CI account to your GitHub account may be something new.
Linking Travis to GitHub allows Travis to access all your GitHub repositories
in order to build and run the project.
Be careful when giving services access to your repository
and only trust well-established and -used services like Travis to have access.

Go through the process of creating an account. 
Then, tell Travis CI which repository you want it to watch.
On the left,
besides the "My Repositories",
click the "+" to add a GitHub repository,
as in Figure \@ref(fig:py-rse-ci-add-repo).
Add the repository we have been using throughout the course.
After finding the repository in the list that pops up,
flick the switch button so that it turns green
(Figure \@ref(fig:py-rse-ci-list-repos)).
If the repository doesn't show up,
re-synchronize the list using the green "Sync account" button on the left sidebar.
If it still doesn't appear,
the repository likely belongs to someone else or is private.

```{r py-rse-ci-add-repo, echo=FALSE, fig.cap="ci-add-repo"}
knitr::include_graphics("figures/rse-ci/add-repo.png")
```

```{r py-rse-ci-list-repos, echo=FALSE, fig.cap="ci-list-repos"}
knitr::include_graphics("figures/rse-ci/list-repos.png")
```

### Configuring a project for Travis

In order for Travis to know what to do with the project repository,
a file called `.travis.yml` must be present inside the repository.
So, let's create this file.

Make the `.travis.yml` file in the root directory of the repository.
(The leading `.` in the name hides the file from casual listings on Mac or Linux,
but not on Windows.)
This file controls Travis CI's operation,
and is written in a format called [YAML][yaml] (Appendix \@ref(py-rse-yaml)).

Now that we have a `.travis.yml` file, open it and add the following line:

```yaml
language: python
```

The `language` key tells Travis CI which programming language[^travis-languages] to use
so that it knows which of its standard [virtual machines][virtual-machine] to use
as a starting point for the project. 

[^travis-languages]: Other [languages available][travis-lang] are listed in the Travis documentation.

Next, let's add a line telling Travis which version of Python to use with the `python` key:

```yaml
language: python

python:
- "3.6"
```

Here we're telling Travis to use Python 3.6. 
If your project requires checking on multiple versions, 
adding another version to check is as simple as adding another line:

```yaml
python:
- "3.6"
- "2.7"
```

Now both 2.7 and 3.6 will be used on the project. Let's stick with 3.6.
Before continuing, complete Exercise \@ref(py-rse-ci-ex-push-yml).

After completing the exercise, 
you'll have seen that Travis CI reports a summary on whether the build passed,
shown in green as in Figure \@ref(fig:py-rse-ci-build-overview),
or whether it produced warnings or errors,
shown in red.

```{r py-rse-ci-build-overview, echo=FALSE, fig.cap="Travis Build Overview"}
knitr::include_graphics("figures/rse-ci/build-overview.png")
```

The log below this overview contains a wealth of information
that can help us debug when the build fails.
We'll make use of this log after adding some build commands.

### Adding Travis CI build commands

After having added the `.travis.yml` file to the repository,
any changes pushed to the GitHub repo will trigger Travis to run its commands.
You may have noticed that Travis didn't really do anything to the code in your project repository.
That's because we haven't yet told Travis to do anything.
Given that we've created some unit tests from Chapter \@ref(py-rse-correct),
let's get Travis to run those tests on its build system.
In the `.travis.yml` file, add a new line and write out:

```yaml
language: python

python:
- "3.6"

script:
- pytest
```

Here we've added a key called `script`
that tells Travis to run the following list of commands,
in this case, only `pytest`.
We can put almost anything here as long as it doesn't need human interaction
(i.e., doesn't ask questions).

Getting CI to run the project tests is the main reason to use CI,
so that any change made can be tested for correctness.
And because Travis runs in a "clean" (new and empty) environment 
(aka, not your own computer),
it can also find problems that don't show up when you test on your own computer.

Before continuing, complete Exercise \@ref(py-rse-ci-ex-add-pytest).

After completing the exercise,
you'll have seen the Travis CI log that is found below the build overview.
The log will contain information on what our test command produces,
whether the test succeeded or failed.

FIXME: Include example here of what failing tests in Python look like in Travis CI.

The project will have failed because of a simple reason:
we use other packages in our Zipf's Law project and Travis doesn't know about them.
So we need to add an additional line to the `.travis.yml` file:

```yaml
language: python

python:
- "3.6"

install:
- pip install -r requirements.txt

script:
- pytest
```

The `install` key tells Travis CI how to install the software we need for our project.
For Python projects,
the list of packages the project depends on is listed in a file called `requirements.txt`.
By using `pip`, these packages are then installed in the Travis environment.
Complete Exercise \@ref(py-rse-ci-ex-requirements) before continuing.

To summarize what Travis has done up until this point, it:

1.  Creates a new Linux virtual machine.
1.  Installs the desired version of Python.
1.  Installs the software described in `requirements.txt`.
1.  Runs the commands below the `script` key.
1.  Reports the results at <code>https://travis-ci.org/<em>user</em>/<em>repo</em></code>,
    where <code><em>user/repo</em></code>
    identifies the repository.

## Reporting code coverage using Travis CI {#py-rse-ci-coverage}

We can also have Travis CI report the [code coverage][code-coverage] of our tests,
as was covered in Section \@ref(py-rse-correct-coverage).

To add code coverage for a Python package,
we add another line to `.travis.yml` to install the code coverage tool
and another to run it:

```yaml
language: python
python:
- "3.6"
install:
- pip install -r requirements.txt
# Install code coverage for CI
- pip install codecov
script:
- pytest
after_success:
# Send to codecov services for report
- codecov
```

We use the Travis key `after_success` so that the coverage tool runs after
the build occurs.
While in Section \@ref(py-rse-correct-coverage) we used the `coverage` tool, 
within Travis we need to use the[`codecov`][codecov] tool instead.

Go to Exercise \@ref(py-rse-ci-ex-coverage) and complete it to add it to the
Zipf's project.

## Display the Travis status on your README {#py-rse-ci-display-github}

Travis CI's dashboard is very useful,
but is also convenient to display the status of the build on our project's GitHub home page
(which most people look at more often).
To add a "status badge" 
(which is an icon that links to the Travis build) to your repo to show Travis' status,
click the "build icon" shown in the top right corner of Figure \@ref(fig:py-rse-ci-github-icon)
to bring up a dialog box.
Select "Markdown" from the "Format" menu list,
then copy the Markdown text displayed in the "Result" box
and paste it into the project's `README.md` file.
(It's best to paste the text right below the page's title so that it will be instantly visible).
Complete Exercise \@ref(py-rse-ci-ex-badge) to add the badge to your README file.
When you've added it,
your project will now show the badge for its Travis CI status as shown in Figure \@ref(fig:py-rse-ci-github-icon).

```{r py-rse-ci-github-icon, echo=FALSE, fig.cap="The Travis CI Build Badge"}
knitr::include_graphics("figures/rse-ci/github-icon.png")
```

## How can I use CI for other purposes? {#py-rse-ci-deploying}

Continuous integration was invented for testing,
but it can be used to automate almost anything.

FIXME: Add an example for deployment Python projects.

## Summary {#py-rse-ci-summary}

FIXME: summarize CI chapter.

## Exercises {#py-rse-ci-exercises}

### Commit and push the Travis YAML file {#py-rse-ci-ex-push-yml}

1. Commit the newly created and edited `.travis.yml` file.
1. Push the changes up to GitHub.
1. Go to the Travis CI page of the GitHub repository. 
1. Once Travis has finished building the project, 
notice the icons and messages that Travis provides. 
What do they show or say?

### Get Travis to run your tests {#py-rse-ci-ex-add-pytest}

After adding the `pytest` command to the `.travis.yml` file, do:

1. Commit the changes.
2. Push the changes to GitHub.
3. Go to the Travis CI project page.
4. Check the log of the build (below the Overview). What does it say?

### Fill in the requirements file {#py-rse-ci-ex-requirements}

In the `requirements.txt` file, each dependency package must be on its own line, 
like so:

```
package1
package2
```

1. Create the file `requirements.txt` in the root directory of the project.
1. Open the file and add the following packages to the `requirements.txt`:
sys, csv, argparse, collections, csv, yaml, re, numpy, pandas, matplotlib, scipy. 
These are all the packages imported into the functions you've created so far.
Remember, each package must be on its own line.
1. Commit the `requirements.txt` file and push to GitHub.
1. Go to the Travis build page and see what it does. 
Does it pass now? What does the log say?

### Commit and push added code coverage {#py-rse-ci-ex-coverage}

1. Add the `codecov` command to the `after_success` key in the `.travis.yml`
file in the Zipf's project.
1. Add, commit, and push the changes to GitHub.
1. Go to the Travis build page and read the log. What is your coverage?

FIXME: I've never used codecov page. Do you have to go to Travis to see the code coverage?

### Put the Travis README badge on your GitHub repo {#py-rse-ci-ex-badge}

Copy and paste the badge from the Travis build page into your `README.md` file.
Then:

1. Commit the changes and push to GitHub.
2. Go to your GitHub project page and check that the badge renders.
3. Click the badge. Where does it take you?

## Key Points {#py-rse-ci-keypoints}

```{r, child="keypoints/rse-ci.md"}
```

```{r, child="./links.md"}
```
